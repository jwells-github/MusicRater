@model ReleaseViewModel
@{ 
    ViewData["Title"] = Model.Release.Title;
    int minimumRating = 1;
    int maximumRating = 10;
    int defaultSelectOption = 10;
    bool releaseRated = false;
    if(Model.UserRating != null)
    {
        if (Model.UserRating.Rating != 0)
        {
            releaseRated = true;
            defaultSelectOption = Model.UserRating.Rating;
        }
    }
}


<div>
    <div>
        <div>
            <h1 class="entryTitle">@Model.Release.Title</h1>
        </div>
        <div class="entryReleaseType">
            <span>@Model.Release.Type by </span>
            <a asp-controller="Artist" asp-action="Profile" asp-route-id="@Model.Release.Artist.ArtistID"
               class="entryArtist">@Model.Release.Artist.Name</a>
        </div>
        <div class="releaseImage entryImage" style="@Model.Release.GetBackgroundCSS()">
            <div>This is an image placeholder</div>
        </div>
        <div>
            <div class="releaseDate">
                <strong>Released: </strong>
                <partial name="_DateSpanPartial" model="new int[] { Model.Release.ReleaseDay, Model.Release.ReleaseMonth, Model.Release.ReleaseYear }">
            </div>
            <strong>Community Rating: </strong>
            <span><strong id="releaseRating">@Model.Release.AverageRating</strong> / 10 from <strong>@Model.Release.NumberOfRatings</strong> ratings</span>
            @if (User.Identity.IsAuthenticated)
            {
                int numberOfGenres = 4;
                <div>
                    @foreach (ReleaseGenre releaseGenre in Model.Release.ReleaseGenres.OrderByDescending(rg => rg.GenreVoting).Skip(0).Take(numberOfGenres))
                    {
                        <a>@releaseGenre.Genre.Name</a>
                    }
                </div>
                <a asp-action="Genres" asp-route-id="@Model.Release.ReleaseID">Suggest a Genre</a>
                <div class="entryVoting">
                    <h3>@(releaseRated ? "You rated this release " + @defaultSelectOption + " / 10" : "You have not rated this release")</h3>
                    <div class="form-group">
                        <form method="post" action="/Release/Rate/@Model.Release.ReleaseID">
                            <select id="rating" name="rating">
                                <option value="0">None</option>
                                @for (int i = maximumRating; i >= minimumRating; i--)
                                {
                                    @if (releaseRated)
                                    {
                                        @if (i == Model.UserRating.Rating)
                                        {
                                            <option selected="selected">@i</option>
                                            continue;
                                        }
                                    }
                                    <option>@i</option>
                                }
                            </select>
                            <button class="btn btn-primary" type="submit">
                                @(releaseRated ? "Update Rating" : "Rate")
                            </button>
                        </form>
                    </div>
                </div>

                <div class="form-group">
                    <form class="reviewForm" method="post" action="/Review/Submit/@Model.Release.ReleaseID">
                        <input name="reviewTitle" id="reviewTitle" placeholder="Review Title"
                                value="@(@Model.UserReview != null ? Model.UserReview.Title : "")" />
                        <textarea name="reviewText" id="reviewText" placeholder="Review Text">@(@Model.UserReview != null ? Model.UserReview.ReviewText : "")</textarea>
                        <button class="btn btn-primary" type="submit">@(@Model.UserReview != null ? "Edit Review" : "Submit Review")</button>
                    </form>
                </div>
                @if (Model.IsAdmin)
                {
                    <div class="form-group">
                        <form method="post" action="/Release/Delete/@Model.Release.ReleaseID">
                            <button class="btn btn-danger" type="submit">Delete Release</button>
                        </form>
                    </div>
                }
            }
</div>
        <div class="entryReviews">
            <h2>User Reviews</h2>
            @foreach (ReleaseReview releaseReview in @Model.ReleaseReviews)
            {
            <div class="releaseReview">
                <div class="releaseReviewMeta">
                    <span><a asp-controller="User" asp-action="Index" asp-route-username="@releaseReview.User.UserName">@releaseReview.User.UserName</a></span>
                    <span>@releaseReview.ReviewDate.ToString("d")</span>
                    <span>@releaseReview.UserVotes.Count Votes</span>
                    <span>Rating: @(releaseReview.ReleaseRating > 0 ? @releaseReview.ReleaseRating.ToString() + "/10" : "n/a")</span>
                </div>
                <h3>@releaseReview.Title</h3>                
                <p>@releaseReview.ReviewText</p>
                @if (User.Identity.IsAuthenticated)
                {
                    <div>
                        @if (releaseReview.UserID != Model.User.Id)
                        {
                            <form method="post" action="/Review/Vote/@releaseReview.ReleaseReviewID">
                                <button class="btn btn-primary" type="submit">
                                    @(releaseReview.UserVotes.Contains(ViewBag.User) ? "Remove Vote" : "Vote")
                                </button>
                            </form>
                        }
                    </div>
                    <div>
                        @if (Model.IsAdmin || releaseReview.UserID == Model.User.Id)
                        {
                            <form method="post" action="/Review/Delete/@releaseReview.ReleaseReviewID">
                                <button class="btn btn-danger" type="submit">
                                    Delete
                                </button>
                            </form>
                        }
                    </div>
                }
            </div>
            }
        </div>
        <div class="entryComments">
            <div>
                @foreach(ReleaseComment comment in Model.Release.Comments)
                {
                    <p>@comment.Text</p>
                }
            </div>
            <form method="post" action="/Comment/Release/@Model.Release.ReleaseID">
                <textarea name="Text" id="Text" placeholder=""></textarea>
                <button class="btn btn-primary" type="submit">Comment</button>
            </form>
        </div>
    </div>
</div>


